<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
	<head x-data="alpineHead()">
		<title x-html="title"></title>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width">
		<meta name="description" :content="description">
		<meta name="keyworks" content="news, rss, feed, aggregator, reader, alpinejs, tailwindcss">

		<link rel="canonical" :href="host">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="manifest" href="/manifest.json">

		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

		<meta name="theme-color" content="#2b7fff">
		<meta name="application-name" :content="title">
		<meta name="msapplication-TileColor" content="#fefefe">
		<meta name="apple-mobile-web-app-status-bar-style" content="#2b7fff">
		<meta name="apple-mobile-web-app-title" :content="title">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">
		<meta property="og:title" :content="title">
		<meta property="og:description" :content="description">
		<meta property="og:image" :content="host + '/favicons/ios/512.png'">
		<meta property="og:image:secure_url" :content="host + '/favicons/ios/512.png'">
		<meta property="og:image:alt" :content="host + '/favicons/ios/512.png'">
		<meta property="og:image:width" content="600">
		<meta property="og:image:height" content="315">
		<meta property="og:url" :content="host + ''">
		<meta property="og:type" content="website">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" :content="title">
		<meta name="twitter:title" :content="title">
		<meta name="twitter:description" :content="description">
		<meta name="twitter:url" :content="host + ''">
		<meta name="twitter:image" :content="host + '/favicons/ios/512.png'">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:creator" content="@royalgarter">

		<script defer src="//cdnjs.cloudflare.com/ajax/libs/alpinejs-intersect/3.14.8/cdn.min.js"></script>
		<script defer src="//cdnjs.cloudflare.com/ajax/libs/alpinejs/3.14.8/cdn.min.js"></script>
		<script defer src="//cdnjs.cloudflare.com/ajax/libs/readability/0.5.0/Readability.js"></script>
		<script async src="//unpkg.com/@tailwindcss/browser@4"></script>
	</head>
	<body x-data="alpineRSS()" class="bg-gray-100 min-h-screen flex flex-col">
		<header class="bg-blue-600 p-4 text-stone-200 text-center">
			<h1 :class="loading ? 'animate-pulse' : ''" class="text-2xl font-bold">The Newsroom RSS</h1>
		</header>
		<main class="container mx-auto p-2 flex-1">
			<div class="flex gap-4 items-center mb-4 justify-self-center">
				<span x-show="error" class="text-red-500" x-text="error"></span>
			</div>

			<template x-for="(feed, index) in feeds" :key="index">
				<section class="rss-feed bg-white shadow rounded mb-4"
					x-cloak x-show="feed?.items?.length > 0"
					x-intersect:once="feed.items.forEach(x => x.prefetchContent())"
				>
					<a :name="feed.anchor" :href="('#' + feed.anchor) || feed.link || feed.rss_url">
						<h2 class="text-indigo-950 text-xl font-bold mx-auto pt-5 sm:pt-4 md:pt-8 px-5 sm:px-4 md:px-8" x-text="feed.title"></h2>
					</a>
					<div class="max-w-screen-2xl mx-auto p-3 sm:p-8 md:p-10">
						<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-6 gap-6">
							<template x-for="(item, itemIndex) in feed.items" :key="itemIndex">
								<div class="rss-item bg-slate-50 rounded overflow-hidden shadow"
									x-intersect:enter="triggerIntersect('enter', item.link)"
									x-intersect:leave="triggerIntersect('leave', item.link)"
									x-intersect.full="triggerIntersect('full', item.link)"
									:class="item.viewed && 'opacity-90 italic'"
								>
									<div x-show="!params?.style?.includes?.('noimg') && item.images?.[0]?.length" class="rss-meta relative">
										<a class="rss-thumb" :href="item.link">
											<img class="rss-thumb w-full max-h-[320px]"
												:src="item.images[0]"
												:alt="item.title">
											<div
												class="hover:bg-transparent transition duration-300 absolute bottom-0 top-0 right-0 left-0 bg-gray-900 opacity-25">
											</div>
										</a>
										<a class="rss-tags" :href="item.link">
											<div class="absolute bottom-0 left-0 bg-indigo-600 px-4 py-2 text-white text-sm hover:bg-white hover:text-indigo-600 transition duration-500 ease-in-out"
												x-html="(timeSince(new Date(item.published)) + ' ago')
													|| new Date(item.published).toString().split(' GMT').shift() 
													|| (item.categories?.join(', ') || item.statistics || feed.short).substr(0, 30).trim()
											">
											</div>
										</a>

										<a class="rss-author" x-show="item.author?.length" :href="item.link_author || item.link">
											<div
												class="text-xs absolute top-0 right-0 bg-indigo-600 p-1 text-white rounded-full h-14 w-14 flex flex-col items-center justify-center mt-3 mr-2 hover:bg-white hover:text-indigo-600 transition duration-500 ease-in-out">
												<!-- <span class="font-bold" x-html="feed.slug"></span> -->
												<small class="break-words text-center" x-html="item.author?.substr(0, 12).trim()"></small>
											</div>
										</a>
									</div>
									<div class="p-4">
										<span x-show="item.viewed" class="py-1 text-xs font-regular text-gray-400 mr-1 flex flex-row items-center">
											<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
												<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />
											</svg>
											<span class="ml-1" x-text="item.viewed"></span>
										</span>
										
										<a :href="item.link"
											:class="item.images?.[0]?.length && 'pointer-events-none'"
											class="rss-title font-semibold text-lg mb-2 inline-block hover:text-indigo-600 transition duration-500 ease-in-out" x-text="item.title">
										</a>
										<p class="rss-desc text-gray-500 text-sm whitespace-pre-line break-words" x-html="item.description || ''">
										</p>
									</div>
									<div :id="'rss-item-article-' + index + '-' + itemIndex">
										<div :class="item.article ? 'visible' : 'invisible'" @click="item.toggleReadmore()" class="cursor-pointer px-4 py-2 flex flex-row items-center">
											<span :class="item.read_more ? 'text-fuchsia-700' : 'text-teal-700'" class="py-1 text-xs font-regular flex flex-row items-center">
												<svg x-show="!item.read_more" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
												  <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0-3.75-3.75M17.25 21 21 17.25" />
												</svg>
												<svg x-show="item.read_more" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
													<path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
												</svg>
												<span class="ml-1" x-text="item.read_more ? 'Collapse' : 'Preview'"></span>
											</span>
										</div>
										<template x-if="item.read_more">
											<div :class="item.read_more ? 'block' : 'hidden'"
												class="block sm:hidden px-4 py-2 flex flex-row items-center bg-amber-50"
												x-intersect:leave="false && (item.read_more = false)"
											>
												<span class="py-1 text-xs font-regular text-gray-600 flex flex-row items-center">
													<p class="rss-article-content text-gray-500 text-sm whitespace-pre-line break-words" x-html="item.article?.content || ''">
													</p>
												</span>
											</div>
										</template>
									</div>
								</div>
							</template>
						</div>
						
						<template x-if="feed.read_more && feed.article">
							<div :id="'rss-feed-article-' + index" x-show="feed.read_more && feed.article"
								class="hidden sm:block pt-4 grid grid-cols-1 gap-6 shadow"
								x-intersect:leave="false && feed.read_more && feed.article && feed.read_more_item?.toggleReadmore()"
							>
								<div class="rounded overflow-hidden shadow bg-amber-50">
									<div class="px-4 py-2 flex flex-row items-center">
										<span class="py-1 text-xl font-bold flex flex-row items-center">
											<p class="rss-article-title text-gray-600 whitespace-pre-line break-words" x-html="feed.article?.title || ''">
											</p>
										</span>
									</div>
									<div class="px-4 py-2 flex flex-row items-center">
										<span class="py-1 text-sm font-regular flex flex-row items-center">
											<p class="rss-article-content text-gray-500 whitespace-pre-line break-words" x-html="feed.article?.content || ''">
											</p>
										</span>
									</div>
									<div @click="feed.read_more_item.toggleReadmore()" class="cursor-pointer p-2 flex flex-row items-center float-right">
										<span class="p-3 text-xs font-regular text-fuchsia-950 flex flex-row items-center">
											<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-8">
											  <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 18.75 7.5-7.5 7.5 7.5" />
											  <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 7.5-7.5 7.5 7.5" />
											</svg>
										</span>
									</div>
								</div>
							</div>
						</template>
					</div>
				</section>
			</template>

			<template x-if="true || !feeds.length">
				<div class="w-full">
					<div class="m-auto my-4 max-w-auto shadow-lg rounded-md">
						<!-- Input -->
						<div class="bg-blue-500 p-4 rounded-t-md">
							<form @submit.prevent="addNewTask">
								<input
									x-model="input"
									class="w-full bg-blue-500 text-white placeholder-gray-200 focus:outline-none border-b-2"
									placeholder="Enter new RSS feed URL..."
								/>
							</form>
						</div>

						<!-- List -->
						<div class="p-3">
							<span x-show="tasks.length <= 0" class="center italic text-gray-400 px-2">RSS is Really Simple Syndication, allows to access updates to websites in a standardized format (e.g., http://feeds.bbci.co.uk/news/rss.xml, https://news.google.com/rss)</span>

							<div @drop.prevent="
								if (drag !== null && drop !== null) {
									if (drag < drop)
										tasks = [
											...tasks.slice(0, drag),
											...tasks.slice(drag + 1, drop + 1),
											tasks[drag],
											...tasks.slice(drop + 1)
										];
									else
										tasks = [
											...tasks.slice(0, drop),
											tasks[drag],
											...tasks.slice(drop, drag),
											...tasks.slice(drag + 1)
										];
									localStorage.setItem(K.tasks, JSON.stringify(tasks));
								};
								drop = null;
								"
								@dragover.prevent="$event.dataTransfer.dropEffect = 'move'"
							>
								<template x-for="(item, index) in tasks" :key="index">
									<div class="p-2 bg-gray-200 mt-2 rounded flex items-center relative"
										:class="{'bg-blue-300': drag === index}"
										style="overflow-wrap: anywhere;"
										draggable="true" @dragstart="drag = index" @dragend="drag = null"
									>
										<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-4">
											<path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
										</svg>
										<div class="mx-2">
											<a :href="item.url" target="_blank"><span x-text="item.url"></span></a>
										</div>
										<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"
											class="size-3 cursor-pointer text-red-500"
											@click="tasks.splice(index, 1);localStorage.setItem(K.tasks, JSON.stringify(tasks));"
										>
											<path stroke-linecap="round" stroke-linejoin="round" d="M13.181 8.68a4.503 4.503 0 0 1 1.903 6.405m-9.768-2.782L3.56 14.06a4.5 4.5 0 0 0 6.364 6.365l3.129-3.129m5.614-5.615 1.757-1.757a4.5 4.5 0 0 0-6.364-6.365l-4.5 4.5c-.258.26-.479.541-.661.84m1.903 6.405a4.495 4.495 0 0 1-1.242-.88 4.483 4.483 0 0 1-1.062-1.683m6.587 2.345 5.907 5.907m-5.907-5.907L8.898 8.898M2.991 2.99 8.898 8.9" />
										</svg>

										<div class="absolute inset-0 opacity-50"
											:class="{'bg-blue-200': drop === index}"
											x-show.transition="drag !== null"
											@dragenter.prevent="if (index !== drag) {drop = index}"
											@dragleave="if (drop === index) drop = null"
										></div>
									</div>
								</template>
							</div>

						</div>

						<!-- Buttons -->
						<div class="bg-blue-500 p-3 flex justify-end rounded-b-md space-x-4">
							<button
								class="cursor-pointer focus:outline-none uppercase text-xs text-blue-100 border-none bg-rose-600 p-2 font-bold rounded shadow"
								x-show="tasks.length > 0"
								@click="clearAllTasks()"
							>
								Clear All
							</button>
							<button
								class="cursor-pointer focus:outline-none uppercase text-xs text-blue-100 border-none bg-emerald-600 p-2 font-bold rounded shadow"
								x-show="tasks.length > 0"
								@click="buildTasks()"
							>
								Build Feeds
							</button>
						</div>
					</div>
				</div>
			</template>

		</main>
		<footer class="bg-gray-300 p-4 text-center text-sm">
			<blockquote class="m-2 text-base italic font-semibold text-stone-900">
				"In the Information Age, ignorance is a choice.", "It's not the news, it's HOW you get the news.", "We just decided to try to do it better."
			</blockquote>
			— <cite>Will McAvoy, The Newsroom by Aaron Sorkin</cite>
		</footer>
	</body>
</html>

<style type="text/tailwindcss">
	[x-cloak] { display: none !important; }

	img {
		max-width: 100%;
		height: auto;
	}

	p [id*="readability-page"] svg {
		display: none;
	}

	p [id*="readability-page"] img {
		padding: 1rem 3rem;
		place-self: center;
	}

	p.rss-article-content > * {
		text-wrap: wrap;
		overflow-wrap: anywhere;
		max-width: 100%;
	}

	p.rss-article-content p {
		padding: 0.5rem 0rem;
	}

	p.rss-article-content img {
		padding: 1rem;
		place-self: center;
	}
</style>

<script>
	if (typeof navigator.serviceWorker !== 'undefined') {
		navigator.serviceWorker.register('sw.js')
	}

	// if (MobileDragDrop) MobileDragDrop.polyfill({holdToDrag: 300, dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride});

	function alpineRSS() {
		return {
			feeds: [],
			loading: false,
			error: null,
			params: {},

			input: '',
			tasks: [],
			drag: null,
			drop: null,

			K: {
				LIMIT: 6,

				viewed: 'v1_viewed_',
				tasks: 'v1_tasks',
				feeds: 'v1_feeds',
				cache: 'v1_cache',
			},

			TRIGGER: {
				LIMIT: 20e3, // time to read article
			},

			CACHE: {},

			triggerIntersect(type, link) {
				if (!link) return console.log('ELINK');

				this.TRIGGER[link] = this.TRIGGER[link] || {};

				let now = new Date();

				switch (type) {
					case 'full'://case 'enter':
						this.TRIGGER[link].tic = Math.min(now, this.TRIGGER[link].tic || now);
					break;
					case 'leave':
						this.TRIGGER[link].toc = Math.max(now, this.TRIGGER[link].toc || now);
						// this.TRIGGER[link].tic = Math.min(this.TRIGGER[link].toc, this.TRIGGER[link].tic || now);

						if (this.TRIGGER[link].tic && this.TRIGGER[link].toc) {
							let delta = this.TRIGGER[link].toc - this.TRIGGER[link].tic;

							this.TRIGGER[link].sum = this.TRIGGER[link].sum || 0; 
							this.TRIGGER[link].sum += delta;

							// console.log('delta', delta)

							if (this.TRIGGER[link].sum > this.TRIGGER.LIMIT) {
								// console.log(' > viewed', link);

								localStorage.setItem(this.K.viewed + link, now.toString().split(' GMT').shift());

								this.feeds.forEach(feed => {
									let found = feed.items.find(x => x.link == link);

									if (!found) return;
									
									found.viewed = localStorage.getItem(this.K.viewed + link);
								});
							} else {
								this.TRIGGER[link].tic = this.TRIGGER[link].toc;
								// console.log(' > reset', link);
							}
						}
					break;
				}
			},

			async fetchFeedUrl(url) {
				try {
					// console.log('fetchFeedUrl', url);
					const response = await fetch(url.replaceAll(' ', '+'), {redirect: 'follow'});

					if (!response.ok || response.status >= 400) return {url};

					const content = await response.text();

					// console.log('fetchFeedUrl', content.length);

					return {url, content};
				} catch (error) {
					// console.warn("Error client fetching feed url:", url/*, error.message*/);

					return {url};
				}
			},

			async loadFeedsWithContent({limit=this.K.LIMIT, limit_adjust=0}) {
				if (this.loading) return;

				this.loading = true;
				this.error = null;

				try {
					let urls = this.params?.urls?.length ? this.params?.urls?.split(',') : [];

					let data = urls?.length ? await Promise.all(urls.map(this.fetchFeedUrl)) : [];

					if (!this.params?.hash && data.length) {
						let hash_local = await this.digest(JSON.stringify(data));
						this.params.hash = hash_local.slice(0, 6);
					}

					const response = await fetch(`/api/feeds?limit=${limit + limit_adjust}&hash=${this.params.hash || ''}`, {
						method: 'POST', 
						headers: {"content-type": "application/json"},
						body: JSON.stringify(data),
					});

					if (!response.ok) throw new Error(`Failed to fetch feeds ${response.status}`)
			
					this.feeds = await response.json();
					this.loading = false;

					if (!this.feeds) return console.log("EEMPTYFEEDS");

					localStorage.setItem(this.K.feeds, JSON.stringify(this.feeds));

					let adjust = this.filterViewedFeeds({limit, auto_fetch_content: true});
					
					if (limit_adjust == 0 && adjust > 0) {
						this.loadFeedsWithContent({limit, limit_adjust: adjust});
					}

					let hash_server = this.feeds?.[0]?.hash;
					if (hash_server) {
						const url = new URL(location);
						url.searchParams.delete("urls");
						url.searchParams.set("hash", hash_server);
						history.pushState({}, "", url);
					}

					this.tasks = this.feeds.map(x => ({url: x.rss_url, checked: false}))
					localStorage.setItem(this.K.tasks, JSON.stringify(this.tasks));
				} catch (error) {
					console.error("Error fetching feeds:", error);
					this.error = "Failed to load feeds. Please check the server logs for more details";
					this.loading = false;
				}
			},

			async digest(txt, algo='SHA-256') {
				return Array.from(
					new Uint8Array(await crypto.subtle.digest(algo, new TextEncoder().encode(txt))),
					(byte) => byte.toString(16).padStart(2, '0')
				).join('');
			},

			isElementInViewport(el) {
				if (typeof jQuery === "function" && el instanceof jQuery) {
					el = el[0];
				}

				let rect = el.getBoundingClientRect();

				return (
					rect.top >= 0 &&
					rect.left >= 0 &&
					rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /* or $(window).height() */
					rect.right <= (window.innerWidth || document.documentElement.clientWidth) /* or $(window).width() */
				);
			},

			timeSince(date) {
				let seconds = Math.floor((new Date() - date) / 1000);

				let interval = seconds / 31536000;

				if (interval > 1) {
					return Math.floor(interval) + " yr";
				}
				interval = seconds / 2592000;
				if (interval > 1) {
					return Math.floor(interval) + " mth";
				}
				interval = seconds / 86400;
				if (interval > 1) {
					return Math.floor(interval) + " day";
				}
				interval = seconds / 3600;
				if (interval > 1) {
					return Math.floor(interval) + " hr";
				}
				interval = seconds / 60;
				if (interval > 1) {
					return Math.floor(interval) + " min";
				}
				return Math.floor(seconds) + " sec";
			},


			filterViewedFeeds({limit=this.K.LIMIT, auto_fetch_content=false}) {
				let count = 0;

				this.feeds.forEach((feed, feedIdx) => {
					if (!feed?.items?.length) return;

					feed.anchor = feed.title?.replace(/[^a-zA-Z0-9]/gi,'').toLowerCase();

					let len_full = feed.items.length;

					feed.items = feed.items.filter(item => {
						let {link} = item;

						if (item.description?.includes('<') || ~item.description?.search(/\&\w+\;/)) {
							item.description = new DOMParser().parseFromString(item.description, "text/html")?.documentElement.textContent;
						}

						item.description = item.description
							?.replace(/\<\/?[^>]*\>/g, '\n\n')
							.replace(/\n\n+/g, '\n\n')
							.replace(/\s+/g, ' ')
							.substr(0, 400)
							.trim() 
						|| '';

						if (len_full <= limit) return true;

						let viewed = localStorage.getItem(this.K.viewed + link);

						if (viewed) return false;

						// console.log(' > skip', link)

						return true;
					});

					let len_filter = feed.items.length;
					let delta = Math.abs(len_full - len_filter);
					count = Math.max(count, delta);

					feed.items = feed.items.slice(0, limit);

					feed.items.forEach(item => {
						item.read_more = false;
						item.prefetching = false;

						item.toggleReadmore = () => {
							item.read_more = !item.read_more;

							if (item.read_more) {
								feed.read_more_item = item;
								feed.read_more = true;
								feed.article = item.article;

								feed.items.filter(x => x.link != item.link).forEach(x => x.read_more = false);

								localStorage.setItem(this.K.viewed + item.link, new Date().toString().split(' GMT').shift());

								setTimeout(() => {
									let fa = document.querySelector('#rss-feed-article-' + feedIdx);
									
									if (window.getComputedStyle(fa).display == 'none') return;

									fa.scrollIntoView(true)
								}, 0.1e3)

								let intervalImg = setInterval(() => {
									let doms = [...document.querySelectorAll('p.rss-article-content img')]
										.filter(x => x.complete && (x.naturalHeight == 0));

									if (doms.length == 0) return clearInterval(intervalImg);

									doms.forEach(x => x.remove())
								}, 0.3e3);
							} else {
								feed.read_more = false;
								feed.read_more_item.read_more = false;

								setTimeout(() => {
									let ia = document.querySelector(`a[href="${item.link}"]`);
									
									if (window.getComputedStyle(ia).display == 'none') return;

									ia.scrollIntoView(true)
								}, 0.1e3)
							}
						};

						item.prefetchContent = async () => {
							if (!auto_fetch_content || item.article?.content || item.prefetching) return;
							item.prefetching = true;

							let resp = null;
							let opts = {
								redirect: "follow",
							};

							try {
								resp = await fetch(item.link, opts);
							} catch (ex) {
								resp = await fetch(`/html?urls=${encodeURIComponent(item.link)}`, opts).catch(null);
							}

							// item.prefetching = false;

							if (resp.status >= 400) return /*console.log(item.link, resp)*/;

							let html = await resp?.text?.().catch(null);

							if (!html) return;

							let doc = new DOMParser().parseFromString(html, "text/html");
							item.article = new Readability(doc).parse();

							let content = item.article?.content;
							if (content?.length) {
								item.article.content = content
									.trim()
									.replace(/<(?!img|table|th|td|tr|p|i|ul|li|h1|h2|h3|h4|h5|h6)[^>]+>/gi, '\n').replace(/<\s*\/\s*[^>]*>/gi, '\n')
									.replace(/\n\n+/gi, '\n\n').trim().replace(/\n\n+/gi, '<br>')
									.replace(/^(\<br\>)+/gi, '').replace(/(\<br\>)+$/gi, '')
									.replace(/(\<br\>\s*\n*)+/gi, '<br>')
									.replace(/\s+/gi, ' ');
							}
						};
					})
				});

				setTimeout(() => {
					let hrefs = [...document.querySelectorAll('a.rss-thumb,a.rss-title')]
						.filter(x => this.isElementInViewport(x))
						.map(a => a.href)
						.filter(x => x);
					// console.log('hrefs', hrefs);

					this.feeds?.forEach?.(feed => feed.items?.filter?.(x => hrefs.includes(x.link)).forEach(x => x.prefetchContent()));
				}, 0.5e3);

				return count;
			},

			addNewTask() {
				try {
					this.input?.split(',').forEach(x => {
						let url = new URL(x).toString();

						let found = this.tasks.find(x => x?.url == url);

						if (found) return;

						this.tasks.push({ url, checked: false });
					});

					localStorage.setItem(this.K.tasks, JSON.stringify(this.tasks));

					this.input = '';
				} catch (ex) {
					alert(ex.message);
				}
			},

			clearAllTasks() {
				this.input = '';
				this.tasks = [];
				localStorage.setItem(this.K.tasks, '');
			},

			buildTasks() {
				let urls = this.tasks?.map?.(x => encodeURIComponent(x.url)).join(',');
				
				let limit = this.params?.limit || this.K.LIMIT;

				window.open(`/?limit=${limit}&hash=${this.params.hash||''}&urls=${urls}`, '_self');
			},

			async init() {
				this.params = Object.fromEntries(new URLSearchParams(location.search));

				let limit = this.params?.limit || this.K.LIMIT;

				if (localStorage.getItem(this.K.tasks)?.length) {
					this.tasks = JSON.parse(localStorage.getItem(this.K.tasks));
				}

				if (localStorage.getItem(this.K.feeds)?.length) {
					this.feeds = JSON.parse(localStorage.getItem(this.K.feeds));
					this.filterViewedFeeds({limit});
				}
				
				this.loadFeedsWithContent({limit});

				Object.entries({...localStorage})
					.filter(
						([k, v]) => k.includes(this.K.viewed) 
									&& (new Date(v) < new Date(Date.now() - 24*60*60e3))
					)
					.forEach( ([k, v]) => localStorage.removeItem(k) )
				;
			}
		}
	}

	function alpineHead() {
		return {
			title: 'The Newsroom RSS',
			description: 'We just decided: The first step in fixing the world is to Be Informed. Get curated news, delivered your way: fast, personalized RSS.',
			host: '//rss.phamthanh.me',
		}
	}

</script>
